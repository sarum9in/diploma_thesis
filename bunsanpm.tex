\section{Репозиторий, пакетный менеджер}
\label{bunsanpm}

\subsection{Назначение}
В гетерогенных вычислительных сетях возникает проблема переносимости
при дистрибуции некоторых типов файлов. К примеру, одна и та же
программа, скомпилированная на одной платформе, может не запускаться
на другой из-за различий окружения: архитектуры процессора, версий системных
библиотек и прочего.

Данную проблему можно решить для любых типов файлов,
которые имеют исходную версию и возможность
компиляции на требуемом множестве платформ.

Задачей пакетного менеджера является генерация заданного набора файлов
в указанной директории. Генерация происходит на текущей машине.
Исходный код хранится на сервере в репозитории.

\subsection{Интерфейс}

\subsubsection{Пакет}
Пакетный менеджер оперирует пакетами и их состояниями.
Пакет идентифицируется строкой, состоящей из
\begin{itemize}
    \item цифр;
    \item латинских символов;
    \item символов подчёркивания;
    \item слэшей.
\end{itemize}

\paragraph{Пакет исходного кода} состоит из множества исходных директорий
и внешних зависимостей. Внешней зависимостью называется указание на состояние другого пакета,
исходное или результирующее. Исходное состояние пакета формируется путём объединения
всех директорий с указанием их точек включения.

\begin{verbatim}
source
{
    self
    {
        subdir1 some_self_source
    }
    import
    {
        source
        {
            . some/source/package1
        }
        package
        {
            subdir2/subdir some/built/package1
        }
    }
}
\end{verbatim}

\paragraph{Результирующий пакет} формируется аналогично пакету исходного кода,
за тем исключением, что в изначально директория формируется из результата сборки
пакета исходного кода. Сборка опускается, если пакет исходного кода пуст.

\begin{verbatim}
package
{
    self
    {
        subdir3 some_self_source
    }
    import
    {
        source
        {
            . some/source/package2
        }
        package
        {
            subdir4/subdir some/built/package2
        }
    }
}
\end{verbatim}

\paragraph{Index-файл} образуется из указаний формирования пакета исходного кода
и результирующего пакета.

\subsubsection{Репозиторий}
Репозиторий -- хранилище пакетов исходного кода.
Так как доступ к репозиторию имеют множество клиентов,
необходимо максимизировать его производительность.

Одним из способов повышения производительности является отказ
от динамически-формируемого контента на сервере. Репозиторий
является статическим хранилищем файлов, потому возможно использовать
различные механизмы кэширования на стороне сервера передачи данных.

Структура репозитория представляет из себя множество вложенных директорий,
некоторые из которых являются пакетами. Пакет состоит из
\begin{itemize}
    \item index-файла, хранящего информацию о сборке пакета;
    \item checksum-файла, хранящего контрольные суммы файлов пакета, в том числе index;
    \item множество архивированных директорий (возможно сжатых).
\end{itemize}

Репозиторий определяется корневым адресом, к примеру \url{http://example.com/repository/}.
Для получения пакета из репозитория необходимо конкатенировать адрес репозитория,
идентификатор пакета и имя нужного файла. Для проверки правильности загрузки файла
используется файл контрольных сумм. Так как репозиторий может динамически обновляться,
что не является атомарной операцией, необходима проверка версии файла, которая соответствует
контрольной сумме. При несоответствии клиент может произвести несколько дополнительных
попыток загрузки файлов.

\subsubsection{API}
Пакетный менеджер предоставляет единственную операцию:
извлечь заданный пакет в заданную директорию.

\begin{verbatim}
void extract(string package, path destination);
\end{verbatim}

Пакетный менеджер распространяется в виде библиотеки,
а также командного интерфейса к библиотеке с аналогичным интерфейсом.

\begin{verbatim}
bunsan_pm_cli --config pm.rc --package package --extract destination
\end{verbatim}

Конфигурация пакетнего менеджера задаётся в виде древовидного
конфигурационного файла.

Файл содержит информацию о подключении к репозиторию, его конфигурацию,
локальные настройки сборки, указание мест для хранения временных файлов и прочее.

Точная структура конфигурации определяется в заголовочном файле
\textbf{bunsan/pm/config.hpp}.